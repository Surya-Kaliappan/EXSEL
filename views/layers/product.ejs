<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/styles/dashboard.css">
</head>
<body>
<main class="main-content">
    <header class="header">
        <h1>Product Tab</h1>
    </header>

    <!-- Suggestions Section -->
    <section class="suggestions hidden" id="suggestionsSection">
        <h2 class="text-xl font-bold p-4">Suggestions for You</h2>
        <div class="suggestions-grid"></div>
    </section>

    <div class="flex justify-content gap-5">
        <input type="text" class="text-gray-900 border border-gray-300 rounded-lg p-2 w-fit h-fit" placeholder="Search by name...">
        <input type="text" class="text-gray-900 border border-gray-300 rounded-lg p-2 w-fit h-fit" placeholder="Search by price...">
        <input type="text" class="text-gray-900 border border-gray-300 rounded-lg p-2 w-fit h-fit" placeholder="Search by address...">
        <button class="p-2 text-white text-lg bg-green-500 w-fit rounded-md justify-end">Search</button>
    </div>
    
    <!-- Product Grid -->
    <section class="product-grid">
        <% products.forEach((product, key) => { 
            if (!(product.seller == user._id)) { %>
            <div class="product-card" data-id="<%- product._id %>" data-key="<%= key %>" data-sel="<%- product.seller %>" id="product">
                <div class="product-photo">
                    <img src="/uploads/<%- product.photo %>" alt="<%- product.name %>">
                </div>
                <div class="product-details">
                    <h3><%- product.name %></h3>
                    <p>Price: <%- product.price %></p>
                </div>
            </div>
        <% }}) %>
    </section>

    <!-- Product Detail Popup -->
    <div class="product-popup-container" id="productPopup">
        <div class="product-popup">
            <div class="popup-actions">
                <button id="closePopup">Back</button>
                <p>Posted on: <span id="popupPosted"></span></p>
                <button class="buy-btn">Buy</button>
            </div>
            <div class="product-image">
                <img id="popupProductPhoto" src="" alt="Product">
            </div>
            <div class="pop-product-details">
                <h2 id="popupProductName"></h2>
                <p class="price" id="popupProductPrice"></p>
                <div class="description">
                    <h3>Description :</h3>
                    <p id="popupProductDescription"></p>
                </div>
                <div class="seller-info">
                    <h3>Seller Information:</h3>
                    <p id="popupSellerName"></p>
                    <p id="popupSellerContact"></p>
                    <p id="popupSellerAddress"></p>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const clickedProduct = document.getElementById('product');
    clickedProduct.addEventListener('click', () => {
        const productPopup = document.getElementById('productPopup');
        const closePopup = document.getElementById('closePopup');
        const productList = document.querySelector('.product-grid');
        const suggestionsSection = document.getElementById('suggestionsSection');
        const suggestionsGrid = document.querySelector('.suggestions-grid');
        const searchButton = document.querySelector('.flex button');
        const searchInputs = document.querySelectorAll('.flex input');

        const productsData = <%- JSON.stringify(products) %>;
        const userName = "<%= user.name %>".toLowerCase(); // Get the user's name

        // Function to suggest products based on user name
        const suggestProducts = () => {
            const keyword = userName.includes('lady') ? 'ladyfinger' : userName;
            const suggestions = productsData.filter(product => 
                product.name.toLowerCase().includes(keyword)
            );

            if (suggestions.length > 0) {
                suggestionsSection.classList.remove('hidden');
                suggestionsGrid.innerHTML = '';
                suggestions.forEach(product => {
                    const suggestionCard = document.createElement('div');
                    suggestionCard.classList.add('product-card');

                    suggestionCard.innerHTML = `
                        <div class="product-photo">
                            <img src="/uploads/${product.photo}" alt="${product.name}">
                        </div>
                        <div class="product-details">
                            <h3>${product.name}</h3>
                            <p>Price: ${product.price}</p>
                        </div>
                    `;
                    suggestionsGrid.appendChild(suggestionCard);
                });
            }
        };

        // Show popup logic
        productList.addEventListener('click', (event) => {
            const card = event.target.closest('.product-card');
            if (!card) return;

            const product = productsData[card.dataset.key];
            const farmer = <%- JSON.stringify(farmers) %>[card.dataset.sel];

            document.getElementById('popupPosted').textContent = product.created;
            document.getElementById('popupProductPhoto').src = card.querySelector('img').src;
            document.getElementById('popupProductName').textContent = product.name;
            document.getElementById('popupProductPrice').textContent = `Price: ${product.price}`;
            document.getElementById('popupProductDescription').textContent = product.description;
            document.getElementById('popupSellerName').textContent = `Name: ${farmer.name}`;
            document.getElementById('popupSellerContact').textContent = `Contact: ${farmer.phone}`;
            document.getElementById('popupSellerAddress').textContent = `Address: ${farmer.address}`;

            productPopup.classList.add('show');
            document.body.style.overflow = 'hidden';
        });

        // Close popup
        closePopup.addEventListener('click', () => {
            productPopup.classList.remove('show');
            document.body.style.overflow = 'auto';
        });

        // Filter products
        searchButton.addEventListener('click', () => {
            const nameFilter = searchInputs[0].value.trim().toLowerCase();
            const priceFilter = searchInputs[1].value.trim();
            const addressFilter = searchInputs[2].value.trim().toLowerCase();

            const filteredProducts = productsData.filter(product => {
                if (nameFilter && !priceFilter && !addressFilter) {
                    return product.name.toLowerCase().includes(nameFilter);
                }
                if (!nameFilter && priceFilter && !addressFilter) {
                    return product.price.toString() === priceFilter;
                }
                if (!nameFilter && !priceFilter && addressFilter) {
                    return product.address.toLowerCase().includes(addressFilter);
                }
                return false;
            });

            productList.innerHTML = '';

            if (filteredProducts.length > 0) {
                filteredProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.classList.add('product-card');

                    productCard.innerHTML = `
                        <div class="product-photo">
                            <img src="/uploads/${product.photo}" alt="${product.name}">
                        </div>
                        <div class="product-details">
                            <h3>${product.name}</h3>
                            <p>Price: ${product.price}</p>
                        </div>
                    `;
                    productList.appendChild(productCard);
                });
            } else {
                productList.innerHTML = '<p class="text-red-500 p-5">No items found</p>';
            }
        });

        // Run suggestions on page load
        suggestProducts();
    });
</script>
</body>
</html>
